name: PR Conflict and Merge Notification

on:
  pull_request:
    types: [opened, synchronize]
  pull_request_target:
    types: [closed]

env:
  TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}

jobs:
  check-conflicts:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == false
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Check for merge conflicts
      run: |
        git fetch origin +refs/heads/${{ github.event.pull_request.base.ref }}:refs/remotes/origin/${{ github.event.pull_request.base.ref }}
        git checkout ${{ github.event.pull_request.base.ref }}
        git merge --no-commit --no-ff ${{ github.event.pull_request.head.ref }} || echo "::set-output name=conflict::true"
      id: conflict-check

    - name: Send conflict notification to Teams
      if: steps.conflict-check.outputs.conflict == 'true'
      run: |
        curl -H 'Content-Type: application/json' -d '{
          "text": "üö® Merge conflict detected in PR #${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }}.",
          "sections": [
            {
              "activityTitle": "Committer: ${{ github.event.pull_request.user.login }}",
              "activitySubtitle": "Branch: ${{ github.event.pull_request.head.ref }} ‚û°Ô∏è ${{ github.event.pull_request.base.ref }}"
            }
          ],
          "potentialAction": [
            {
              "@type": "OpenUri",
              "name": "View in GitHub",
              "targets": [
                { "os": "default", "uri": "${{ github.event.pull_request.html_url }}" }
              ]
            }
          ]
        }' $TEAMS_WEBHOOK_URL

  notify-merge:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    steps:
    - name: Send merge notification to Teams
      run: |
        curl -H 'Content-Type: application/json' -d '{
          "text": "‚úÖ PR #${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }} has been successfully merged.",
          "sections": [
            {
              "activityTitle": "Committer: ${{ github.event.pull_request.user.login }}",
              "activitySubtitle": "Branch: ${{ github.event.pull_request.head.ref }} ‚û°Ô∏è ${{ github.event.pull_request.base.ref }}"
            }
          ],
          "potentialAction": [
            {
              "@type": "OpenUri",
              "name": "View in GitHub",
              "targets": [
                { "os": "default", "uri": "${{ github.event.pull_request.html_url }}" }
              ]
            }
          ]
        }' $TEAMS_WEBHOOK_URL
